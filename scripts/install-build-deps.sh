#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -e


# -- Check if running as root.

if [ "$EUID" -ne 0 ]; then
    APT_COMMAND="sudo apt"
else
    APT_COMMAND="apt"
fi


# -- Add third-aprty repository keys.

add_repo_key_and_source() {
    local key_id="$1"
    local keyring_file="$2"
    local source_file="$3"
    local source_content="$4"

    if ! gpg --list-keys "$key_id" &>/dev/null; then
        gpg --batch --keyserver hkps://keyserver.ubuntu.com --recv-keys "$key_id"
    fi

    if ! [ -f "$keyring_file" ] || ! gpg --quiet --with-colons --import-options show-only --import "$keyring_file" | grep -q "$key_id"; then
        gpg --batch --yes --export "$key_id" | gpg --dearmor -o "$keyring_file"
    fi

    if ! grep -Fxq "$source_content" "$source_file" 2>/dev/null; then
        echo "$source_content" > "$source_file"
    fi
}

add_repo_key_and_source \
    "E6D4736255751E5D" \
    "/etc/apt/keyrings/kde_neon-archive-keyring.gpg" \
    "/etc/apt/sources.list.d/neon-repo.list" \
    "deb [signed-by=/etc/apt/keyrings/kde_neon-archive-keyring.gpg] https://origin.archive.neon.kde.org/stable/ jammy main"


# -- Install build packages.

$APT_COMMAND update -q
$APT_COMMAND install -qy - --no-install-recommends \
    appstream \
    automake \
    autotools-dev \
    build-essential \
    checkinstall \
    cmake \
    curl \
    devscripts \
    equivs \
    extra-cmake-modules \
    flac \
    gettext \
    git \
    gnupg2 \
    libalsaplayer-dev \
    libavcodec-dev\
    libavdevice-dev \
    libavfilter-dev \
    libavformat-dev \
    libavutil-dev \
    libcddb2-dev \
    libcdio-cdda-dev \
    libcdio-dev \
    libcdio-paranoia-dev \
    libfaac-dev \
    libfdk-aac-dev \
    libflac-dev \
    libgme-dev \
    libjack-dev \
    libkf6config-dev \
    libkf6coreaddons-dev \
    libkf6i18n-dev \
    libmad0-dev \
    libmpcdec-dev \
    libmpg123-dev \
    libogg-dev \
    libopus-dev \
    libopusfile-dev \
    libpipewire-0.3-dev \
    libpostproc-dev \
    libpulse-dev \
    libqt6qmlcompiler6 \
    libshout-dev \
    libsidplayfp-dev \
    libsndfile1-dev \
    libsoxr-dev \
    libspa-0.2-dev \
    libswresample-dev \
    libswscale-dev \
    libtag1-dev \
    libvorbis-dev \
    libwavpack-dev \
    libwildmidi-dev \
    libxmp-dev \
    lintian \
    qt6-base-dev \
    qt6-base-private-dev \
    qt6-declarative-dev \
    qt6-declarative-private-dev \
    qt6-multimedia-dev \
    wavpack


# -- Add package from our repository.

mkdir -p /etc/apt/keyrings

curl -fsSL https://packagecloud.io/nitrux/zbkit/gpgkey | gpg --dearmor -o /etc/apt/keyrings/nitrux_zbkit-archive-keyring.gpg

cat <<EOF > /etc/apt/sources.list.d/nitrux-zbkit.list
deb [signed-by=/etc/apt/keyrings/nitrux_zbkit-archive-keyring.gpg] https://packagecloud.io/nitrux/zbkit/debian/ bullseye main
EOF

$APT_COMMAND update -q
$APT_COMMAND install -y - --no-install-recommends \
    mauikit
